"use strict";define("classroom-lesson-details-controller",[],function(){function e(e,s,n){function o(){e.init(),t(),a()}function t(){e.getProjectSyllabus(s.projectId).then(function(){l(),i(),p.defaultSelectedLesson=e.getDefaultSelectedLesson(s.sectionId,s.lessonId)},function(e){p.errors.projectSyllabusFetching=e})}function l(){e.getLessonDetails(s.sectionId,s.lessonId).then(function(){p.lessonDetails=e.lessonDetails[p.defaultSelectedLesson.lessonId].data},function(e){p.errors.lessonDetailsFetching=e})}function i(){e.getRecentLessonDiscussions(s.lessonId).then(function(e){p.recentLessonDiscussions=e},function(e){p.errors.recentLessonDiscussionsFetching=e})}function a(){p.events.reloadLessonDetails=r,p.events.reloadProjectSyllabus=c,p.events.reloadRecentLessonDiscussions=d,p.events.onLessonChange=u,p.events.nextLesson=f,p.events.previousLesson=m,p.events.learnMoreVA=g}function r(){p.errors.lessonDetailsFetching=null,l()}function c(){p.errors.projectSyllabusFetching=null,t()}function d(){p.errors.recentLessonDiscussionsFetching=null,i()}function u(s){e.goToLessonDetails(s)}function f(){e.goToNextLesson(s.sectionId,s.lessonId)}function m(){e.goToPreviousLesson(s.sectionId,s.lessonId)}function g(){e.openInfoDialog()}var p=this;p.lessonDetails={},p.messages=e.messages,p.paths=e.paths,p.request=e.request,p.ajaxLoaderClassroomLessonDetails={msg:p.messages.getMessage("loadingLessonDetails"),loaderImg:p.paths.ajaxLoaderImg},p.ajaxLoaderClassroomLessonMaterials={msg:p.messages.getMessage("loadingLessonMaterials"),loaderImg:p.paths.ajaxLoaderImg},p.ajaxLoaderClassroomLessonPlan={msg:p.messages.getMessage("loadingLessonPlan"),loaderImg:p.paths.ajaxLoaderImg},p.ajaxLoaderClassroomRecentLessonDiscussions={msg:p.messages.getMessage("loadingRecentLessonDiscussions"),loaderImg:p.paths.ajaxLoaderImg},p.errors={lessonDetailsFetching:null,projectSyllabusFetching:null,recentLessonDiscussionsFetching:null},p.events={},o()}return e.$inject=["classroomLessonDetailsService","$stateParams","$state"],e}),define("classroom-lesson-details-service",[],function(){function e(e,s,n,o,t,l,i,a,r,c,d,u,f,m,g,p,D,I,v){function h(){P()}function L(t){function l(e){var s={error:!0,msg:o.getComponentMessages("projects").getMessage("projectSyllabusFetchFailed")};return s}return E&&E.promise,E=e.defer(),V.request.fetchingProjectSyllabus=!0,n.getProjectSyllabus(t).then(function(){var e=n.projectSyllabus[t].data;V.request.fetchingProjectSyllabus=!1,R.lessonId=e.length?e[0].lesson_id:0,R.sectionId=e.length?e[0].section_id:0,E.resolve()},function(e){return V.request.fetchingProjectSyllabus=!1,s.lessonId?E.resolve():void(E&&(E.reject(l()),E=null))}),E.promise}function j(e,n){function t(){if(V.lessonDetails.hasOwnProperty(d)&&V.lessonDetails[d].promise){if(V.lessonDetails[d].promise.exist())return V.lessonDetails[d].promise;V.lessonDetails[d].promise.recreatePromise()}else V.lessonDetails[d]={},V.lessonDetails[d].promise=g.createPromise();return a()}function a(){function e(e){var s={};return e.hasOwnProperty("lessonDetails")&&e.hasOwnProperty("lessonMaterials")&&(s={sectionId:u,lessonId:d,lessonDescription:l.trustAsHtml(e.lessonDetails.lesson_details),lessonVideo:l.trustAsResourceUrl(e.lessonDetails.lesson_video),lessonName:e.lessonDetails.lesson_display_name?e.lessonDetails.lesson_display_name:e.lessonDetails.lesson_name,lessonMaterials:S(e.lessonMaterials,!0),allLessonMaterial:S(e.lessonMaterials)}),s}function s(e){var s={error:!0,msg:""};switch(e.code){default:s.msg=o.getComponentMessages("classroomLessonDetailsMessages").getMessage("lessonDetailsFetchFail")}return s}return V.request.fetchingClassroomLessonDetails=!0,i.getClassroomLessonDetails({lesson_id:d}).$promise.then(function(s){V.request.fetchingClassroomLessonDetails=!1,V.lessonDetails[d].data=e(s),V.lessonDetails[d].promise.resolve()},function(e){V.request.fetchingClassroomLessonDetails=!1,V.lessonDetails[d].promise.reject(s(e)),V.lessonDetails[d].promise.destroy(),delete V.lessonDetails[d]}),V.lessonDetails[d].promise}var r=v.get("lastVisitedLesson"+s.projectId);if(!e&&!n&&r){var c=JSON.parse(r);R.lessonId=c.lessonId,R.sectionId=c.sectionId}var d=n?n:R.lessonId,u=e?e:R.sectionId;if(r){var c=JSON.parse(r);parseInt(c.lessonId)!==parseInt(d)&&(T(u,d),v.putObject("lastVisitedLesson"+s.projectId,{sectionId:u,lessonId:d}))}else T(u,d),v.putObject("lastVisitedLesson"+s.projectId,{sectionId:u,lessonId:d});return t()}function S(e,s){function n(e,s,n,t){o.push({id:e,fileUrl:I.getFileUrl({folderName:p.getBaseLessonS3Container(),filePath:t+"/"+s,isDownload:!0}),fileName:n})}for(var o=[],t=0;t<e.length;t++)s?1===parseInt(e[t].is_downloadable)&&n(e[t].id,e[t].file_name,e[t].file_mask_name,e[t].lesson_repo):n(e[t].id,e[t].file_name,e[t].file_mask_name,e[t].lesson_repo);return o}function N(n){function t(e){for(var s,n={userDefaultImage:r.getUserDefaultImageUrl(),details:[]},o=0;o<e.length;o++)s=c.invokeTimeZoneMethod("UTC","getLocalCustomDateTimeByTimestamp")(e[o].asked_at),n.details.push({questionId:e[o].question_id,displayName:e[o].name,askedAt:s,questionTitle:e[o].question_title,totalReply:e[o].total_reply}),function(s){r.getUserImageUrl({fileName:e[s].user_image_path,folderName:e[s].user_folder}).then(function(e){n.details[s].image_url=e.url})}(o);return n}function l(e){var s={error:!0,msg:""};switch(e.code){default:s.msg=o.getComponentMessages("classroomDiscussionsMessage").getMessage("discussionFetchingFailed")}return s}A&&A.promise,A=e.defer(),V.request.fetchingLessonDiscussions=!0,V.request.lessonDiscussionNotExists=!1;var d=n?n:R.lessonId;return i.getLessonDiscussionsByFilter({userId:0,lessonId:d,projectId:s.projectId,startLimit:0,endLimit:5}).$promise.then(function(e){V.request.fetchingLessonDiscussions=!1,e=a.processData(e),0===e.length&&(V.request.lessonDiscussionNotExists=!0),A.resolve(t(e))},function(e){V.request.fetchingLessonDiscussions=!1;var s=a.processError(e);A&&(A.reject(l(s)),A=null)}),A.promise}function M(e,s){_(e,s,"next")}function b(e,s){_(e,s,"previous")}function _(e,o,t){var l,i=[],a=e?e:R.sectionId,r=o?o:R.lessonId;n.getProjectSyllabus(s.projectId).then(function(){for(var e=n.projectSyllabus[s.projectId].data,o=0;o<e.length;o++)i.push({sectionId:parseInt(e[o].section_id),lessonId:parseInt(e[o].lesson_id)});for(var o=0;o<i.length;o++)if(i[o].sectionId===parseInt(a)&&i[o].lessonId===parseInt(r)){if("next"===t){l=o+1,parseInt(i.length)===parseInt(l)&&(l=0);break}if("previous"===t){l=o-1,0===parseInt(o)&&(l=i.length-1);break}}return d.go("root.classroom.lesson-details",{sectionId:i[l].sectionId,lessonId:i[l].lessonId})})}function y(e){e&&d.go("root.classroom.lesson-details",{sectionId:e.sectionId,lessonId:e.lessonId})}function C(e,s){return{sectionId:e?e:R.sectionId,lessonId:s?s:R.lessonId}}function U(){return{fetchingClassroomLessonDetails:!1,fetchingProjectSyllabus:!1,fetchingLessonDiscussions:!1,lessonDiscussionNotExists:!1}}function P(){D.listenEvent({componentName:"lessonDetailsUpdate",eventName:u.events.onSessionUpdate,eventCallback:F}),D.listenEvent({componentName:"lessonDetailsUpdate",eventName:p.events.onLessonInfoUpdate,eventCallback:x}),D.listenEvent({componentName:"lessonDetailsUpdate",eventName:p.events.onFileIsDownloadableUpdate,eventCallback:k}),D.listenEvent({componentName:"lessonDetailsUpdate",eventName:p.events.onFileDelete,eventCallback:w}),D.listenEvent({componentName:"lessonDetailsUpdate",eventName:p.events.onFileUpload,eventCallback:$})}function F(){var e=v.getAll();for(var s in e)s.startsWith("lastVisitedLesson")&&v.remove(s);R={},E=null,A=null,V.request=U()}function q(){m.infoDialog({templateUrl:t.getPath("classroom.verified-answer.create.verified-answer-infographic-html")})}function x(e,s){V.lessonDetails[s.lessonId].data.lessonDescription=l.trustAsHtml(s.lessonDetails.lessonText),V.lessonDetails[s.lessonId].data.lessonVideo=l.trustAsResourceUrl(s.lessonDetails.lessonVideo),V.lessonDetails[s.lessonId].data.lessonName=s.lessonDetails.lessonDisplayName?s.lessonDetails.lessonDisplayName:s.lessonDetails.lessonName}function k(e,s){var n=V.lessonDetails[s.fileDetails.lessonId].data.lessonMaterials,o=V.lessonDetails[s.fileDetails.lessonId].data.allLessonMaterial;if(s.fileDetails.isDownloadable)for(var t=0;t<o.length;t++)parseInt(o[t].id)===parseInt(s.fileDetails.fileId)&&n.push(o[t]);else for(var t=0;t<n.length;t++)parseInt(n[t].id)===parseInt(s.fileDetails.fileId)&&n.splice(t,1)}function w(e,s){for(var n=V.lessonDetails[s.fileDetails.lessonId].data.lessonMaterials,o=0;o<n.length;o++)parseInt(n[o].id)===parseInt(s.fileDetails.fileId)&&n.splice(o,1)}function $(e,s){var n=V.lessonDetails[s.fileDetails.lessonId].data.lessonMaterials,o=V.lessonDetails[s.fileDetails.lessonId].data.allLessonMaterial;"/"+s.fileDetails.fileName+"/"+s.fileDetails.fileMaskName;s.fileDetails.isDownloadable&&n.push({id:s.fileDetails.fileId,fileUrl:I.getFileUrl({folderName:p.getBaseLessonS3Container(),filePath:s.fileDetails.lessonRepo+"/"+s.fileDetails.fileName,isDownload:!0}),fileName:s.fileDetails.fileMaskName}),o.push({id:s.fileDetails.fileId,fileUrl:I.getFileUrl({folderName:p.getBaseLessonS3Container(),filePath:s.fileDetails.lessonRepo+"/"+s.fileDetails.fileName,isDownload:!0}),fileName:s.fileDetails.fileMaskName})}function T(e,n){i.createUserClassroomLessonVisitLog({projectId:s.projectId,sectionId:e,lessonId:n})}var V,R={},E=null,A=null;return V={init:h,getProjectSyllabus:L,getLessonDetails:j,lessonDetails:{},goToLessonDetails:y,goToNextLesson:M,goToPreviousLesson:b,openInfoDialog:q,getDefaultSelectedLesson:C,getRecentLessonDiscussions:N,messages:o.getComponentMessages("classroomLessonDetailsMessages"),paths:{ajaxLoaderImg:t.getPath("images.content-loader")},request:U()}}return e.$inject=["$q","$stateParams","projectService","messageService","pathService","$sce","rest","restMiddleware","userImageService","dateService","$state","session","$rootScope","popup","promiseService","lessonService","eventService","fileHelperService","$cookies"],e}),define("lesson-video-resize-directive",[],function(){function e(e){function s(e,s,n,o){function t(e){var n=['<iframe height="450px" width="100%" id="video" src = "'+e+'" frameborder="0" allowfullscreen>',"</iframe>"].join("");s.html(n)}n.$observe("lessonVideoUrl",function(e){e&&t(e)})}return{restrict:"E",scope:{lessonVideoUrl:"@"},link:s}}return e.$inject=["pathService"],e}),define("app/classroom/lesson-details/classroom-lesson-details.runtime.js",["classroom-lesson-details-controller","classroom-lesson-details-service","lesson-video-resize-directive"],function(e,s,n){return{ClassroomLessonDetailsController:e,classroomLessonDetailsService:s,lessonVideoResizeDirective:n}});